<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Typing Test - Stable Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1a1c23;
            --gold: #d4af37;
            --error: #ff4b2b;
            --success: #2ecc71;
            --muted: #636e72;
            --light: #dfe6e9;
        }
        body {
            background: var(--bg); color: var(--light);
            font-family: 'Sarabun', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0;
        }
        .container { text-align: center; width: 90%; max-width: 900px; }
        .time-selector { margin-bottom: 20px; }
        .time-btn {
            padding: 8px 20px; margin: 0 5px; background: none; border: 1px solid var(--muted);
            color: var(--light); border-radius: 20px; cursor: pointer;
        }
        .time-btn.active { background: var(--gold); color: #000; border-color: var(--gold); font-weight: bold; }
        
        #stats-bar {
            display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px;
        }
        .stat-val { display: block; font-size: 2rem; color: var(--gold); font-weight: bold; }
        
        #word-container {
            height: 120px; overflow: hidden; font-size: 24px; line-height: 1.6;
            background: #252a34; padding: 25px; border-radius: 12px; margin-bottom: 20px;
            text-align: left; position: relative;
        }
        .word { display: inline-block; margin-right: 12px; color: var(--muted); }
        .word.current { color: #fff; background: rgba(212, 175, 55, 0.3); border-radius: 4px; }
        .word.correct { color: var(--success); }
        .word.incorrect { color: var(--error); text-decoration: underline; }

        #input-field {
            width: 100%; max-width: 500px; padding: 15px; font-size: 22px;
            border: 2px solid #3d4451; border-radius: 10px; outline: none; text-align: center;
        }
        #input-field.input-error { background: #fff0f0; color: var(--error); border-color: var(--error); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--gold);">ระบบทดสอบพิมพ์สัมผัสตำรวจ</h1>

    <div class="time-selector" id="selector">
        <button class="time-btn" onclick="setTime(60, this)">1 นาที</button>
        <button class="time-btn" onclick="setTime(120, this)">2 นาที</button>
        <button class="time-btn active" onclick="setTime(180, this)">3 นาที</button>
    </div>

    <div id="stats-bar">
        <div><span id="timer" class="stat-val">03:00</span><span>เวลา</span></div>
        <div><span id="wpm" class="stat-val">0</span><span>WPM</span></div>
        <div><span id="accuracy" class="stat-val">0%</span><span>แม่นยำ</span></div>
    </div>

    <div id="word-container"></div>
    <input type="text" id="input-field" placeholder="เริ่มพิมพ์คำแรก..." autocomplete="off">
    <br><br>
    <button class="time-btn" onclick="resetGame()" style="border-color: var(--gold);">เริ่มใหม่</button>
</div>

<script>
    const vocab = [
        "พนักงานสอบสวน", "เจ้าพนักงาน", "ชุดสืบสวน", "ผู้เสียหาย", "ผู้ต้องหา", "พยาน", "ร้อยเวร", "สายตรวจ", 
        "แจ้งข้อกล่าวหา", "ลงบันทึกประจำวัน", "ทำแผนประกอบ", "ดำเนินการ", "ตรวจยึด", "พยานหลักฐาน", "ตรวจสอบ", 
        "ที่เกิดเหตุ", "เคหสถาน", "เวลาวิกาล", "ดำเนินคดี", "กฎหมายอาญา", "พระราชบัญญัติ", "โดยประมาท", "เจตนา"
    ];

    let words = [], currentIndex = 0, selectedTime = 180, timer = 180;
    let isStarted = false, interval = null, correctChars = 0, totalTyped = 0, errors = 0;

    const input = document.getElementById('input-field');
    const display = document.getElementById('word-container');

    function setTime(s, btn) {
        if (isStarted) return;
        selectedTime = timer = s;
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('timer').innerText = formatTime(s);
    }

    function formatTime(s) {
        return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
    }

    function resetGame() {
        clearInterval(interval);
        isStarted = false;
        timer = selectedTime;
        currentIndex = 0; correctChars = 0; totalTyped = 0; errors = 0;
        input.value = ""; input.disabled = false;
        document.getElementById('timer').innerText = formatTime(timer);
        document.getElementById('wpm').innerText = "0";
        document.getElementById('accuracy').innerText = "0%";
        document.getElementById('selector').style.opacity = "1";
        
        // สุ่มคำแบบไม่ซ้ำ (Shuffle)
        words = [...vocab].sort(() => Math.random() - 0.5);
        render();
    }

    function render() {
        display.innerHTML = words.map((w, i) => `<span id="w-${i}" class="word ${i===0?'current':''}">${w}</span>`).join('');
    }

    input.addEventListener('input', () => {
        if (!isStarted && input.value.trim() !== "") {
            isStarted = true;
            document.getElementById('selector').style.opacity = "0.2";
            interval = setInterval(() => {
                timer--;
                document.getElementById('timer').innerText = formatTime(timer);
                if (timer <= 0) endGame();
                updateStats();
            }, 1000);
        }

        const currentWord = words[currentIndex];
        const val = input.value;

        // ไฮไลท์สีแดงในช่องพิมพ์ทันทีถ้าผิด
        input.className = currentWord.startsWith(val.trim()) ? "" : "input-error";

        if (val.endsWith(' ')) {
            const typed = val.trim();
            if (typed === "") { input.value = ""; return; }

            const el = document.getElementById(`w-${currentIndex}`);
            totalTyped++;

            if (typed === currentWord) {
                el.className = 'word correct';
                correctChars += currentWord.length + 1;
            } else {
                el.className = 'word incorrect';
                errors++;
            }

            currentIndex++;
            input.value = "";
            input.className = "";

            // เติมคำเพิ่มถ้าใกล้หมด
            if (currentIndex >= words.length - 2) {
                const extra = [...vocab].sort(() => Math.random() - 0.5);
                words = words.concat(extra);
                render(); // Re-render เฉพาะเมื่อจำเป็น
            }
            
            // เลื่อนตำแหน่งคำ
            const nextEl = document.getElementById(`w-${currentIndex}`);
            if (nextEl) {
                nextEl.className = 'word current';
                // ใช้ scrollTo แทน scrollIntoView เพื่อลดการค้าง
                display.scrollTop = nextEl.offsetTop - 40;
            }
            updateStats();
        }
    });

    function updateStats() {
        const elapsed = selectedTime - timer;
        if (elapsed > 0) {
            const wpm = Math.round((correctChars / 5) / (elapsed / 60));
            document.getElementById('wpm').innerText = wpm;
            const acc = Math.round(((totalTyped - errors) / totalTyped) * 100);
            document.getElementById('accuracy').innerText = (acc || 0) + "%";
        }
    }

    function endGame() {
        clearInterval(interval);
        input.disabled = true;
        alert("จบการทดสอบ!\nWPM: " + document.getElementById('wpm').innerText);
    }

    resetGame();
</script>

</body>
</html>
